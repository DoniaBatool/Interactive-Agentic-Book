# Data Model: Selection-Based RAG Engine

**Feature**: 051-selection-rag
**Date**: 2025-01-27
**Purpose**: Define data structures and entities for selection-based RAG system

## Entity Definitions

### 1. Selection Request (Primary Entity)

**Description**: Represents a user's selection and question about selected text

**Storage**: Transient (sent via API request)

**Structure**:
```python
SelectionRequest = {
    "selected_text": str,      # The highlighted text (10-10000 chars)
    "question": str,           # User's question (1-1000 chars)
    "chapter_id": int          # Chapter where selection was made
}
```

**Validation Rules**:
- `selected_text`: min_length=10, max_length=10000
- `question`: min_length=1, max_length=1000
- `chapter_id`: integer >= 1, must be valid chapter

---

### 2. Selection Response (Primary Entity)

**Description**: Response to selection-based question

**Storage**: Transient (returned via API response)

**Structure**:
```python
SelectionResponse = {
    "answer": str,             # Generated answer
    "context_used": str,       # Context snippet used
    "confidence": float        # Confidence score (0.0-1.0, placeholder)
}
```

**Example**:
```python
{
    "answer": "Based on the selected text, the concept refers to...",
    "context_used": "The selected text mentions that robots use sensors...",
    "confidence": 0.85
}
```

---

### 3. Cleaned Selection Text (Processing Entity)

**Description**: Normalized version of selected text after cleaning

**Storage**: In-memory during processing

**Structure**:
```python
CleanedSelection = {
    "original": str,           # Original selected text
    "cleaned": str,            # Cleaned text (normalized whitespace, etc.)
    "length": int              # Character count
}
```

**Cleaning Rules**:
- Remove extra whitespace
- Normalize line breaks
- Handle special characters
- Preserve meaning

---

### 4. Selection Context (Processing Entity)

**Description**: Assembled context for LLM from selected text

**Storage**: In-memory during processing

**Structure**:
```python
SelectionContext = {
    "selected_text": str,      # Cleaned selected text
    "question": str,          # User's question
    "context": str,           # Assembled context string
    "chunks": List[Dict]      # Retrieved chunks (if any, placeholder)
}
```

**Context Assembly Rules**:
- Primary context: selected text
- Optional: related chunks from chapter (future)
- Max context length: 2000 characters (placeholder)

---

### 5. Selection Pipeline State (Processing Entity)

**Description**: State during pipeline processing

**Storage**: In-memory during processing

**Structure**:
```python
PipelineState = {
    "request": SelectionRequest,
    "cleaned_text": str,
    "embedding": List[float],  # Placeholder
    "chunks": List[Dict],      # Placeholder
    "context": str,
    "answer": str              # Final answer
}
```

---

## Relationships

### Request → Response
- One request produces one response
- Request contains selection and question
- Response contains answer and context used

### Selection → Cleaned Text
- One selection produces one cleaned text
- Cleaning is deterministic
- Original text is preserved for reference

### Cleaned Text → Context
- One cleaned text produces one context
- Context may include additional chunks (future)
- Context is assembled for LLM

### Context → Answer
- One context produces one answer
- Answer is generated by LLM (future)
- Answer references context used

---

## Data Flow

### Selection Capture Flow
```
User highlights text in MDX
  → Frontend extracts selection
  → Check if length > 10 chars
  → Show SelectionRAGBar
  → User enters question
  → POST /api/rag/selection
```

### Pipeline Processing Flow
```
API receives request
  → Validate input
  → Call selection_engine.process_selection_query()
    → Call selection_pipeline.clean_selected_text()
    → Call selection_pipeline.embed_selected_text() (TODO)
    → Call selection_pipeline.run_similarity_search_over_selected() (TODO)
    → Call selection_pipeline.pass_context_to_llm() (TODO)
    → Return response
```

### Skills Integration Flow
```
selection_cleaning_skill.clean_selection()
  → Input: raw selected text
  → Output: cleaned text
  → Used by: selection_pipeline

selection_context_skill.build_selection_context()
  → Input: selected text, chunks
  → Output: assembled context
  → Used by: selection_pipeline
```

---

## Notes

- All data structures are transient (no persistence)
- Selection text is limited to prevent abuse
- Context assembly is focused on selected text only
- Future: May include related chunks from chapter
- Future: May cache cleaned text and embeddings
